<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="funding.dao.FDaoC">

	<!-- 로그인, 회원가입 부분 -->
	<delete id="leave">
	DELETE FROM ADDRESS WHERE ADDRESS_CUSTOMER = #{param1}
	</delete>
	<select id="login" resultType="String">
	SELECT CUSTOMER_ID FROM CUSTOMER WHERE CUSTOMER_ID = #{param1} AND CUSTOMER_PW = #{param2}
	</select>
	<insert id="signUp" >
	INSERT INTO CUSTOMER(CUSTOMER_ID, CUSTOMER_PW, CUSTOMER_NAME, CUSTOMER_PHONE, CUSTOMER_PW_Q, CUSTOMER_PW_A)
	 values(#{param1}, #{param2}, #{param3}, #{param4}, #{param5}, #{param6})
	</insert>
	<insert id="addAddress">
	INSERT INTO ADDRESS (ADDRESS_CUSTOMER, ADDRESS_STATE, ADDRESS_CITY, ADDRESS_LINE)
	 VALUES(#{param1}, #{param2}, #{param3}, #{param4})
	</insert>
	<select id="findId" resultType="String">
	SELECT CUSTOMER_ID FROM CUSTOMER WHERE CUSTOMER_NAME = #{param1} AND CUSTOMER_PHONE = #{param2}
	</select>
	<select id="findpw" resultType="String">
	SELECT CUSTOMER_PW FROM CUSTOMER WHERE CUSTOMER_ID = #{param1}
	 AND CUSTOMER_PW_Q = #{param2} AND CUSTOMER_PW_A = #{param3}
	</select>
	<select id="checkCustomer" resultType="String">
	SELECT CUSTOMER_ID FROM CUSTOMER WHERE CUSTOMER_ID = #{value}
	</select>
	<select id="checkSeller" resultType="String">
	SELECT SELLER_ID FROM SELLER WHERE SELLER_ID = #{value}
	</select>

	<!-- 메인-->
	<select id="mainlist" resultType="funding.dto.FDtoFunding">
	SELECT FUNDING_NUM, FUNDING_SELLER, FUNDING_BANNER, FUNDING_TITLE, FUNDING_OPENAT, FUNDING_CLOSEAT, FUNDING_STATE,
	(SELECT SUM(ORDER_PRICE*ORDER_COUNT) FROM ORDER1 O 
	WHERE O.ORDER_FUNDING = F.FUNDING_NUM GROUP BY ORDER_FUNDING)/FUNDING_PURPOSE*100 AS FUNDING_ACHIEVEMENT, 
	(SELECT SUM(ORDER_PRICE*ORDER_COUNT) FROM ORDER1 O WHERE O.ORDER_FUNDING = F.FUNDING_NUM GROUP BY ORDER_FUNDING) AS TOTAL 
	FROM FUNDING AS F ${value}
	</select>
	
	<!-- 펀딩 상세-->
	<select id="orderList" resultType="funding.dto.FDtoOrder">
	SELECT ORDER_CUSTOMER, ORDER_AT, (ORDER_PRICE * ORDER_COUNT) AS ORDER_COST FROM ORDER1 WHERE ORDER_FUNDING = ${value}
	</select>
	<select id="checkLike" resultType="String">
	SELECT LIKE_FUNDING AS FUNDING_NUM FROM FUNDING_LIKE WHERE LIKE_CUSTOMER = '${param1}' AND LIKE_FUNDING = ${param2}
	</select>
	<select id="funding_detail" resultType="funding.dto.FDtoFunding">
	SELECT FUNDING_TITLE, FUNDING_BANNER, FUNDING_PURPOSE,FUNDING_OPENAT, FUNDING_CLOSEAT,
	(SELECT CONTENT_CONTENT FROM FUNDING_CONTENT WHERE FUNDING_CONTENT.CONTENT_FUNDING = F.FUNDING_NUM)AS CONTENT, 
	(SELECT SUM(ORDER_PRICE*ORDER_COUNT) FROM ORDER1 O 
	WHERE O.ORDER_FUNDING = F.FUNDING_NUM GROUP BY ORDER_FUNDING)/FUNDING_PURPOSE*100 AS FUNDING_ACHIEVEMENT, 
	(SELECT SELLER_NAME FROM SELLER S WHERE F.FUNDING_SELLER = S.SELLER_ID) AS SELLER_NAME, 
	(SELECT SUM(ORDER_PRICE*ORDER_COUNT) FROM ORDER1 O WHERE O.ORDER_FUNDING = F.FUNDING_NUM GROUP BY ORDER_FUNDING) AS TOTAL, 
	(SELECT COUNT(DISTINCT ORDER_CUSTOMER) FROM ORDER1 O WHERE O.ORDER_FUNDING = F.FUNDING_NUM) AS COUNT, 
	FUNDING_NUM, 
	(SELECT SELLER_PROFILE FROM SELLER S WHERE F.FUNDING_SELLER = S.SELLER_ID) AS SELLER_PROFILE
	FROM FUNDING F WHERE FUNDING_NUM = ${value}
	</select>
	<select id="optionList" resultType="funding.dto.FDtoFundingOption">
	SELECT OPTION_NUM, OPTION_NAME, OPTION_PRICE, OPTION_AMOUNT, COUNT(OPTION_NUM) AS COUNT 
	FROM FUNDING_OPTION WHERE OPTION_FUNDING = ${value} GROUP BY OPTION_NUM
	</select>
	<select id="questionList" resultType="funding.dto.FDtoFundingQuestion">
	SELECT QUESTION_CUSTOMER, QUESTION_CONTENT, QUESTION_AT, QUESTION_ANSWER, QUESTION_ANSWER_AT FROM FUNDING_QUESTION WHERE QUESTION_FUNDING = ${value}
	</select>
	
	<insert id="likeInsert">
	INSERT INTO FUNDING_LIKE (LIKE_CUSTOMER, LIKE_FUNDING, LIKE_AT) VALUES (#{param1}, ${param2}, NOW())
	</insert>
	<delete id="unlike">
	DELETE FROM FUNDING_LIKE WHERE LIKE_CUSTOMER = #{param1} AND LIKE_FUNDING = ${param2}
	</delete>
	<insert id="OrderInsert">
	INSERT INTO ORDER1 (ORDER_CUSTOMER, ORDER_FUNDING, ORDER_OPTION, ORDER_PRICE, ORDER_COUNT, ORDER_AT)
	 VALUES(#{param1}, ${param2}, ${param3}, ${param4}, ${param5}, NOW())
	</insert>
	<insert id="question_create">
	INSERT INTO FUNDING_QUESTION (QUESTION_CUSTOMER, QUESTION_FUNDING, QUESTION_SELLER, QUESTION_CONTENT, QUESTION_AT, QUESTION_STATE) 
	VALUES(#{param2}, ${param1}, (SELECT FUNDING_SELLER FROM FUNDING WHERE FUNDING_NUM = ${param1}), #{param3}, NOW(), '답변대기')
	</insert>

	<!-- 게시판 카운트 -->
	<select id="myFundingCount" resultType="int">
	SELECT COUNT(FUNDING_NUM) FROM FUNDING AS F WHERE FUNDING_NUM IN (SELECT ORDER_FUNDING FROM ORDER1 WHERE ORDER_CUSTOMER = #{param1} )
	</select>
	<select id="myLikeCount" resultType="int">
	SELECT COUNT(FUNDING_NUM) FROM FUNDING AS F WHERE FUNDING_NUM IN (SELECT LIKE_FUNDING FROM FUNDING_LIKE L WHERE L.LIKE_CUSTOMER = #{param1})
	</select>
	<select id="mySystemQuestionCount" resultType="int">
	SELECT COUNT(QUESTION_NUM) FROM SYSTEM_QUESTION WHERE QUESTION_CUSTOMER = #{param1}
	</select>
	<select id="myFundingQuestionCount" resultType="int">
	SELECT COUNT(QUESTION_NUM) FROM FUNDING_QUESTION Q WHERE QUESTION_CUSTOMER = #{param1}
	</select>
	<select id="countNotice" resultType="int">
	SELECT COUNT(NOTICE_NUM) FROM NOTICE
	</select>
	<select id="countFunding" resultType="int">
	SELECT COUNT(FUNDING_NUM) FROM FUNDING WHERE FUNDING_STATE = '진행'
	</select>
	<select id="select_hits" resultType="int">
	SELECT FUNDING_HITS FROM FUNDING WHERE FUNDING_NUM = ${value}
	</select>
	<update id="update_hits">
	UPDATE FUNDING SET FUNDING_HITS = ${param1} WHERE FUNDING_NUM = ${param2}
	</update>
	<select id="countQuestion" resultType="int">
	SELECT COUNT(QUESTION_NUM) FROM SYSTEM_QUESTION
	</select>
	<!-- 게시판 리스트 -->
	<select id="notice_list" resultType="funding.dto.FDtoNotice">
	SELECT NOTICE_NUM, NOTICE_TITLE, NOTICE_AT FROM NOTICE ORDER BY NOTICE_AT DESC LIMIT 10 OFFSET ${value}
	</select>
	<select id="notice_search" resultType="funding.dto.FDtoNotice">
	SELECT NOTICE_NUM, NOTICE_TITLE, NOTICE_AT FROM NOTICE WHERE NOTICE_TITLE LIKE '%${value}%' OR NOTICE_CONTENT LIKE '%${value}%'
	</select>
	<select id="notice_detail" resultType="funding.dto.FDtoNotice">
	SELECT * FROM NOTICE WHERE NOTICE_NUM = ${value}
	</select>
	<select id="funding_list_view" parameterType="int" resultType="funding.dto.FDtoFunding">
	SELECT FUNDING_NUM, FUNDING_SELLER, FUNDING_TITLE, FUNDING_OPENAT, FUNDING_CLOSEAT 
	, (SELECT SELLER_NAME FROM SELLER AS S WHERE F.FUNDING_SELLER = S.SELLER_ID) 
	FROM FUNDING AS F WHERE FUNDING_STATE = '진행' ORDER BY FUNDING_NUM DESC LIMIT 10 OFFSET ${value}
	</select>
	<select id="fundingsearch" resultType="funding.dto.FDtoFunding">
	SELECT FUNDING_NUM, FUNDING_SELLER, FUNDING_TITLE, FUNDING_OPENAT, FUNDING_CLOSEAT, 
	(SELECT SELLER_NAME FROM SELLER AS S WHERE F.FUNDING_SELLER = S.SELLER_ID) FROM FUNDING AS F WHERE FUNDING_TITLE 
	LIKE '%${value}%' OR (SELECT SELLER_NAME FROM SELLER AS S WHERE F.FUNDING_SELLER = S.SELLER_ID) LIKE '%${value}%'
	</select>
	<select id="systemquestion_view" resultType="funding.dto.FDtoSystemQuestion">
	SELECT QUESTION_NUM, QUESTION_TITLE, QUESTION_AT, QUESTION_STATE FROM SYSTEM_QUESTION ORDER BY QUESTION_AT DESC LIMIT 10 OFFSET ${value}
	</select>
	<select id="systemquestion_search" resultType="funding.dto.FDtoSystemQuestion">
	SELECT * FROM SYSTEM_QUESTION WHERE QUESTION_TITLE LIKE '%${value}%' OR QUESTION_CONTENT LIKE '%${value}%' 
	OR QUESTION_ANSWER LIKE '%${value}%'
	</select>
	<select id="systemquestion_detail" resultType="funding.dto.FDtoSystemQuestion">
	SELECT * FROM SYSTEM_QUESTION WHERE QUESTION_NUM = ${value}
	</select>
	<insert id="create_systemQuestion">
	INSERT INTO SYSTEM_QUESTION (QUESTION_CUSTOMER, QUESTION_ADMIN, QUESTION_TITLE, QUESTION_CONTENT, QUESTION_AT, QUESTION_STATE)
	 VALUES(#{param1}, 'ADMIN@ADMIN.COM', #{param2}, #{param3}, NOW(), '답변대기')
	</insert>
	<!-- 마이페이지 -->
	<select id="mysystemquestion_list" resultType="funding.dto.FDtoSystemQuestion">
	SELECT * FROM SYSTEM_QUESTION WHERE QUESTION_CUSTOMER = #{param1} ORDER BY QUESTION_AT DESC LIMIT 10 OFFSET ${param2}
	</select>
	<select id="myfundingquestion_list" resultType="funding.dto.FDtoFundingQuestion">
	SELECT QUESTION_CUSTOMER, (SELECT FUNDING_TITLE FROM FUNDING F WHERE F.FUNDING_NUM = Q.QUESTION_FUNDING), 
	QUESTION_CONTENT, QUESTION_AT, QUESTION_STATE, QUESTION_ANSWER, QUESTION_ANSWER_AT, QUESTION_FUNDING 
	FROM FUNDING_QUESTION Q WHERE QUESTION_CUSTOMER = #{param1} ORDER BY QUESTION_AT DESC LIMIT 10 OFFSET ${param2}
	</select>
	<select id="myfundinglist" resultType="funding.dto.FDtoFunding">
	SELECT FUNDING_NUM, FUNDING_SELLER, FUNDING_TITLE, FUNDING_OPENAT, FUNDING_CLOSEAT, 
	(SELECT SELLER_NAME FROM SELLER AS S WHERE F.FUNDING_SELLER = S.SELLER_ID) AS SELLER_NAME FROM FUNDING AS F 
	WHERE FUNDING_NUM IN (SELECT ORDER_FUNDING FROM ORDER1 WHERE ORDER_CUSTOMER = #{param1}) 
	ORDER BY FUNDING_NUM DESC LIMIT 10 OFFSET ${param2}
	</select>
	<select id="mylikelist" resultType="funding.dto.FDtoFunding">
	SELECT FUNDING_NUM, FUNDING_SELLER, FUNDING_TITLE, FUNDING_OPENAT, FUNDING_CLOSEAT , 
	(SELECT SELLER_NAME FROM SELLER AS S WHERE F.FUNDING_SELLER = S.SELLER_ID) AS SELLER_NAME FROM FUNDING AS F 
	WHERE FUNDING_NUM IN (SELECT LIKE_FUNDING FROM FUNDING_LIKE L WHERE L.LIKE_CUSTOMER = #{param1}) 
	ORDER BY FUNDING_NUM DESC LIMIT 10 OFFSET ${param2}

	</select>
	<select id="myorder_funding" resultType="funding.dto.FDtoFunding">
	SELECT FUNDING_NUM, FUNDING_TITLE, FUNDING_STATE, (SELECT SELLER_NAME FROM SELLER S WHERE F.FUNDING_SELLER = S.SELLER_ID) 
	FROM FUNDING F WHERE FUNDING_NUM = ${value}
	</select>
	<select id="myorder_ordering" resultType="funding.dto.FDtoOrder">
	SELECT ORDER_PRICE, ORDER_COUNT, ORDER_AT,
	(SELECT OPTION_NAME FROM FUNDING_OPTION FO WHERE O.ORDER_OPTION = FO.OPTION_NUM) AS OPTION_NAME FROM ORDER1 O WHERE ORDER_FUNDING = ${param1} AND ORDER_CUSTOMER = #{param2}
	</select>
	<update id="update_infor">
	UPDATE CUSTOMER SET CUSTOMER_PW = ${param2}, CUSTOMER_PHONE = ${param3} WHERE CUSTOMER_ID = ${param1}
	</update>
</mapper>